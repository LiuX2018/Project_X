<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of prop_field_abcd_2d</title>
  <meta name="keywords" content="prop_field_abcd_2d">
  <meta name="description" content="_________________________________________________________________">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # AODParentDir --><!-- # Diffraction_Module --><!-- ../menu.html Existing_Propagators --><!-- menu.html Fresnel_Paraxial -->
<h1>prop_field_abcd_2d
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>_________________________________________________________________</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function [efds,xs,ys,rxsg,rysg,iprox,iproy,famp,Nfx,Nfy,Nfsx,Nfsy,ierr,sterr]=prop_field_abcd_2d(efd,wl,xp,yp,abcdx,abcdy,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">_________________________________________________________________


 Aufruf:
 [efds,xs,ys,rxsg,rysg,iprox,iproy,famp,Nfx,Nfy,Nfsx,Nfsy,ierr,sterr]=prop_field_abcd_2d

 (efd,wl,xp,yp,abcdx,abcdy)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs,
                                                                 naxmax,naymax)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs,
                                                           naxmax,naymax,iptyp)
 (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs,
                                             naxmax,naymax,iptyp,idampx,idampy)
 
 Schlagworte: 
 Propagation, Fresnel, diffraction, Collins, integral, abcd, field   

 Kurzbeschreibung:  
 2-D-beam propagation in Fresnel approximation through paraxial orthogonal systems 

 Beschreibung:  
 Propagation of a complex field through a paraxial orthogonal ABCD-segment 
 in two dimensions.
 The computation is performed independently in the x- and y-section.
 Most of the parameters can be made different in x and y.
 The system is considered as to be orthogonal without mixing x- and
 y-components. The input-field may have coupling terms. 
 The control of the optimal choice of the algorithm is done 
 automatically if desired. This automatic may fail, if the parameters are
 critical. The case of a collimated beam is realized, if the divergence
 angle is less than 5 mrad. The critical value of the Fresnel number is
 chosen at Nf = 1. These values are arbitrary. If the automatic choice of
 the propagator fails, it must be chosen explicite by the user.
 In this case, the zero padding of the given profile, the scaling factor scalx
 and a control of a proper calculation of the spatial spectrum famp is recommended.
 Internal, the geometrical contributions of the phase curvature are removed
 to get a better conditioning of the Fourier transform. The geometrical contribution
 in the final plane is indicated at the output. If the beam undergoes an intermediate 
 focus, the direction of the coordinate system is not flipped.
 The absolute phase factor due to exp(ikz) is not taken into account in this routine.
 Usually, it is recommended to use the scaling factor to get a proper resolution of the
 spatial spectrum. This is controlled by the parameter scalx. In this case, the chirp-z-
 transform is used. If scalx = 1, the classical FFT is used internally to save 
 computational time.
 In the computation, the beam power should remain constant. This energie conservation
 can be violated, if the spectrum or the final beam is truncated. 

 
 Version:  08.06.08  Herbert Gross  Matlab 7.4      first version
           13.06.08  Erweiterung: auch 2x2-ABCD Matrizen möglich 
           18.06.08  Verbesserung: nan entfernt
           20.07.08  Sign of curvature reversed, sign of FFT/CZT, 
                     smooth transition between FFT+CZT
           20.02.09  Modified by Ingrid Schuster:  
                     fft routines and call of chirp-z exchanged to prevent 
                     flip of coordinate system
           10.12.09  Correction by H. Gross for case I-O
           07.02.10   Correction by H. Gross, starting values of rx, ry,
                     Phase of O-I and I-O cases,
                     Sign-reversal for single-FFT cases
           13.10.10  Correction of finite indices br
                     Correction of a special error case for nearly I-I

  Input:
    efd(npy,npx)  : complex 2d input field
    wl            : wavelength
    xp(npx)       : x-coordinate at start
    yp(npy)       : y-coordinate at start
    abcdx(4)      : paraxial matrix of transfer in x-section
                    a matrix abcdx(2,2) is also possible
    abcdy(4)      : paraxial matrix of transfer in y-section
                    a matrix abcdy(2,2) is also possible

  varargin:
    rx            : radius of curvature in starting plane in x-section
                    rx &gt; 0 describes a convergent wave
    ry            : radius of curvature in starting plane in y-section
    iropt         : automatic optimization of inital curvatures rx, ry
                    0= must be given, 1=automatic adaptation [ 0 ]
                    if 1, rx, ry serves as starting guess values
    scalx         : scale factor into frequency space in x-section
                    scalx &gt; 1 better resolution in frequency space       
                    scalx = 1 corresponds to FFT and is faster
    scaly         : scale factor into frequency space in y-section (see above)
    iproxi        : fixed propagator type in x-section, internal choice is overwritten
                    with this input, 0= no forced propagator
                    1=Ix-Ix , 2=Ox-Ix , 3=Ix-Ox , 4=Ox-Ox 
    iproyi        : fixed propagator type in y-section, internal choice is overwritten
                    1=Iy-Iy , 2=Oy-Iy , 3=Iy-Oy , 4=Oy-Oy 
    xs(npx)       : Option : fixed given exit coordinate grid in x-section
    ys(npy)       : Option : fixed given exit coordinate grid in y-section
    br            : refractive index in starting plane
    brs           : refractive index in final plane
    naxmax        : maximum apertur for cases O-O, I-I and I-O in x-section      
                    naxmax = 0 : no truncation
    naxmay        : maximum apertur for cases O-O, I-I and I-O in y-section      
    iptyp         : type of x/y-propagator: 0=Fresnel 1=plane waves 2=Sommerfeld
                    For 1+2 no separated propagation distances are possible Bx = By
    idampx        : option : damping of frequency spectrum towards the rim in x
                    idampx &lt; 1 is the exponent of the cos-shape
    idampy        : option : damping of frequency spectrum towards the rim in y

  Output:   

    efds(npy,npx) : complex field in final plane
    xs(npx)       : final coordinate grid in x-section
    ys(npy)       : final coordinate grid in y-section
    famp(npy,npx) : absolute value of frequency spectrum
    rxsg          : radius of curvature in the final plane in x-section,
                    rxs &gt; 0 is a divergent wave
    rysg          : radius of curvature in the final plane in y-section,
    iprox         : realized propagation type in x-section :
                    1=Ix-Ix , 2=Ox-Ix , 3=Ix-Ox , 4=Ox-Ox 
    iproy         : realized propagation type in y-section :
                    1=Iy-Iy , 2=Oy-Iy , 3=Iy-Oy , 4=Oy-Oy 
    ierr          : error flag:
                    ierr = 0 : no error 
                    ierr = 1 : determinante of matrix ist not consistent
                    ierr = 2 : xs/ys is given with non-compatible length
                    ierr = 3 : fixed xs causes sampling error
                    ierr = 4 : wrong input value of scalx, scaly
    sterr         : string with error comment

 Abhängigkeiten in 1. Ordnung:  czt_2d
                                curv_radius
 Referenzen:  prop_field_abcd.doc  
 Beispiel: --
 Testfile: prop_field_abcd_2d_test.m
 ToDo:  1. different refractive indices not tested until now
_________________________________________________________________</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/curv_radius.html" class="code" title="function [rxo,ryo] = curv_radius(efd,wl,xp,yp,varargin)">curv_radius</a>	_________________________________________________________________</li><li><a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/czt_2d.html" class="code" title="function xout = czt_2d( xin , scalx , scaly , idir )">czt_2d</a>	___________________________________________________________________________________</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="prop_field_abcd_2d_test.html" class="code" title="">prop_field_abcd_2d_test</a>	Test Fresnel-Propagator nach Collins in zwei Dimensionen</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [efds,xs,ys,rxsg,rysg,iprox,iproy,famp,Nfx,Nfy,Nfsx,Nfsy,ierr,sterr]=</a><span class="keyword">...</span>
0002 prop_field_abcd_2d(efd,wl,xp,yp,abcdx,abcdy,varargin)
0003 <span class="comment">%_________________________________________________________________</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Aufruf:</span>
0007 <span class="comment">% [efds,xs,ys,rxsg,rysg,iprox,iproy,famp,Nfx,Nfy,Nfsx,Nfsy,ierr,sterr]=prop_field_abcd_2d</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy)</span>
0010 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry)</span>
0011 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt)</span>
0012 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly)</span>
0013 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi)</span>
0014 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys)</span>
0015 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br)</span>
0016 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs)</span>
0017 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs,</span>
0018 <span class="comment">%                                                                 naxmax,naymax)</span>
0019 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs,</span>
0020 <span class="comment">%                                                           naxmax,naymax,iptyp)</span>
0021 <span class="comment">% (efd,wl,xp,yp,abcdx,abcdy,rx,ry,iropt,scalx,scaly,iproxi,iproyi,xs,ys,br,brs,</span>
0022 <span class="comment">%                                             naxmax,naymax,iptyp,idampx,idampy)</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% Schlagworte:</span>
0025 <span class="comment">% Propagation, Fresnel, diffraction, Collins, integral, abcd, field</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% Kurzbeschreibung:</span>
0028 <span class="comment">% 2-D-beam propagation in Fresnel approximation through paraxial orthogonal systems</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Beschreibung:</span>
0031 <span class="comment">% Propagation of a complex field through a paraxial orthogonal ABCD-segment</span>
0032 <span class="comment">% in two dimensions.</span>
0033 <span class="comment">% The computation is performed independently in the x- and y-section.</span>
0034 <span class="comment">% Most of the parameters can be made different in x and y.</span>
0035 <span class="comment">% The system is considered as to be orthogonal without mixing x- and</span>
0036 <span class="comment">% y-components. The input-field may have coupling terms.</span>
0037 <span class="comment">% The control of the optimal choice of the algorithm is done</span>
0038 <span class="comment">% automatically if desired. This automatic may fail, if the parameters are</span>
0039 <span class="comment">% critical. The case of a collimated beam is realized, if the divergence</span>
0040 <span class="comment">% angle is less than 5 mrad. The critical value of the Fresnel number is</span>
0041 <span class="comment">% chosen at Nf = 1. These values are arbitrary. If the automatic choice of</span>
0042 <span class="comment">% the propagator fails, it must be chosen explicite by the user.</span>
0043 <span class="comment">% In this case, the zero padding of the given profile, the scaling factor scalx</span>
0044 <span class="comment">% and a control of a proper calculation of the spatial spectrum famp is recommended.</span>
0045 <span class="comment">% Internal, the geometrical contributions of the phase curvature are removed</span>
0046 <span class="comment">% to get a better conditioning of the Fourier transform. The geometrical contribution</span>
0047 <span class="comment">% in the final plane is indicated at the output. If the beam undergoes an intermediate</span>
0048 <span class="comment">% focus, the direction of the coordinate system is not flipped.</span>
0049 <span class="comment">% The absolute phase factor due to exp(ikz) is not taken into account in this routine.</span>
0050 <span class="comment">% Usually, it is recommended to use the scaling factor to get a proper resolution of the</span>
0051 <span class="comment">% spatial spectrum. This is controlled by the parameter scalx. In this case, the chirp-z-</span>
0052 <span class="comment">% transform is used. If scalx = 1, the classical FFT is used internally to save</span>
0053 <span class="comment">% computational time.</span>
0054 <span class="comment">% In the computation, the beam power should remain constant. This energie conservation</span>
0055 <span class="comment">% can be violated, if the spectrum or the final beam is truncated.</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% Version:  08.06.08  Herbert Gross  Matlab 7.4      first version</span>
0059 <span class="comment">%           13.06.08  Erweiterung: auch 2x2-ABCD Matrizen möglich</span>
0060 <span class="comment">%           18.06.08  Verbesserung: nan entfernt</span>
0061 <span class="comment">%           20.07.08  Sign of curvature reversed, sign of FFT/CZT,</span>
0062 <span class="comment">%                     smooth transition between FFT+CZT</span>
0063 <span class="comment">%           20.02.09  Modified by Ingrid Schuster:</span>
0064 <span class="comment">%                     fft routines and call of chirp-z exchanged to prevent</span>
0065 <span class="comment">%                     flip of coordinate system</span>
0066 <span class="comment">%           10.12.09  Correction by H. Gross for case I-O</span>
0067 <span class="comment">%           07.02.10   Correction by H. Gross, starting values of rx, ry,</span>
0068 <span class="comment">%                     Phase of O-I and I-O cases,</span>
0069 <span class="comment">%                     Sign-reversal for single-FFT cases</span>
0070 <span class="comment">%           13.10.10  Correction of finite indices br</span>
0071 <span class="comment">%                     Correction of a special error case for nearly I-I</span>
0072 <span class="comment">%</span>
0073 <span class="comment">%  Input:</span>
0074 <span class="comment">%    efd(npy,npx)  : complex 2d input field</span>
0075 <span class="comment">%    wl            : wavelength</span>
0076 <span class="comment">%    xp(npx)       : x-coordinate at start</span>
0077 <span class="comment">%    yp(npy)       : y-coordinate at start</span>
0078 <span class="comment">%    abcdx(4)      : paraxial matrix of transfer in x-section</span>
0079 <span class="comment">%                    a matrix abcdx(2,2) is also possible</span>
0080 <span class="comment">%    abcdy(4)      : paraxial matrix of transfer in y-section</span>
0081 <span class="comment">%                    a matrix abcdy(2,2) is also possible</span>
0082 <span class="comment">%</span>
0083 <span class="comment">%  varargin:</span>
0084 <span class="comment">%    rx            : radius of curvature in starting plane in x-section</span>
0085 <span class="comment">%                    rx &gt; 0 describes a convergent wave</span>
0086 <span class="comment">%    ry            : radius of curvature in starting plane in y-section</span>
0087 <span class="comment">%    iropt         : automatic optimization of inital curvatures rx, ry</span>
0088 <span class="comment">%                    0= must be given, 1=automatic adaptation [ 0 ]</span>
0089 <span class="comment">%                    if 1, rx, ry serves as starting guess values</span>
0090 <span class="comment">%    scalx         : scale factor into frequency space in x-section</span>
0091 <span class="comment">%                    scalx &gt; 1 better resolution in frequency space</span>
0092 <span class="comment">%                    scalx = 1 corresponds to FFT and is faster</span>
0093 <span class="comment">%    scaly         : scale factor into frequency space in y-section (see above)</span>
0094 <span class="comment">%    iproxi        : fixed propagator type in x-section, internal choice is overwritten</span>
0095 <span class="comment">%                    with this input, 0= no forced propagator</span>
0096 <span class="comment">%                    1=Ix-Ix , 2=Ox-Ix , 3=Ix-Ox , 4=Ox-Ox</span>
0097 <span class="comment">%    iproyi        : fixed propagator type in y-section, internal choice is overwritten</span>
0098 <span class="comment">%                    1=Iy-Iy , 2=Oy-Iy , 3=Iy-Oy , 4=Oy-Oy</span>
0099 <span class="comment">%    xs(npx)       : Option : fixed given exit coordinate grid in x-section</span>
0100 <span class="comment">%    ys(npy)       : Option : fixed given exit coordinate grid in y-section</span>
0101 <span class="comment">%    br            : refractive index in starting plane</span>
0102 <span class="comment">%    brs           : refractive index in final plane</span>
0103 <span class="comment">%    naxmax        : maximum apertur for cases O-O, I-I and I-O in x-section</span>
0104 <span class="comment">%                    naxmax = 0 : no truncation</span>
0105 <span class="comment">%    naxmay        : maximum apertur for cases O-O, I-I and I-O in y-section</span>
0106 <span class="comment">%    iptyp         : type of x/y-propagator: 0=Fresnel 1=plane waves 2=Sommerfeld</span>
0107 <span class="comment">%                    For 1+2 no separated propagation distances are possible Bx = By</span>
0108 <span class="comment">%    idampx        : option : damping of frequency spectrum towards the rim in x</span>
0109 <span class="comment">%                    idampx &lt; 1 is the exponent of the cos-shape</span>
0110 <span class="comment">%    idampy        : option : damping of frequency spectrum towards the rim in y</span>
0111 <span class="comment">%</span>
0112 <span class="comment">%  Output:</span>
0113 <span class="comment">%</span>
0114 <span class="comment">%    efds(npy,npx) : complex field in final plane</span>
0115 <span class="comment">%    xs(npx)       : final coordinate grid in x-section</span>
0116 <span class="comment">%    ys(npy)       : final coordinate grid in y-section</span>
0117 <span class="comment">%    famp(npy,npx) : absolute value of frequency spectrum</span>
0118 <span class="comment">%    rxsg          : radius of curvature in the final plane in x-section,</span>
0119 <span class="comment">%                    rxs &gt; 0 is a divergent wave</span>
0120 <span class="comment">%    rysg          : radius of curvature in the final plane in y-section,</span>
0121 <span class="comment">%    iprox         : realized propagation type in x-section :</span>
0122 <span class="comment">%                    1=Ix-Ix , 2=Ox-Ix , 3=Ix-Ox , 4=Ox-Ox</span>
0123 <span class="comment">%    iproy         : realized propagation type in y-section :</span>
0124 <span class="comment">%                    1=Iy-Iy , 2=Oy-Iy , 3=Iy-Oy , 4=Oy-Oy</span>
0125 <span class="comment">%    ierr          : error flag:</span>
0126 <span class="comment">%                    ierr = 0 : no error</span>
0127 <span class="comment">%                    ierr = 1 : determinante of matrix ist not consistent</span>
0128 <span class="comment">%                    ierr = 2 : xs/ys is given with non-compatible length</span>
0129 <span class="comment">%                    ierr = 3 : fixed xs causes sampling error</span>
0130 <span class="comment">%                    ierr = 4 : wrong input value of scalx, scaly</span>
0131 <span class="comment">%    sterr         : string with error comment</span>
0132 <span class="comment">%</span>
0133 <span class="comment">% Abhängigkeiten in 1. Ordnung:  czt_2d</span>
0134 <span class="comment">%                                curv_radius</span>
0135 <span class="comment">% Referenzen:  prop_field_abcd.doc</span>
0136 <span class="comment">% Beispiel: --</span>
0137 <span class="comment">% Testfile: prop_field_abcd_2d_test.m</span>
0138 <span class="comment">% ToDo:  1. different refractive indices not tested until now</span>
0139 <span class="comment">%_________________________________________________________________</span>
0140 <span class="comment">%</span>
0141 
0142 <span class="comment">%  Defaults for optional input parameters</span>
0143 <span class="comment">%</span>
0144 
0145 <span class="keyword">if</span> nargin &gt;  7 ; rx = varargin{1} ; ry = varargin{2} ; 
0146 <span class="keyword">else</span> ; rx = 0 ; ry = 0 ;<span class="keyword">end</span>
0147 <span class="keyword">if</span> nargin &gt;  8 ; iropt = varargin{3} ; <span class="keyword">else</span> ; iropt = 0 ; <span class="keyword">end</span>
0148 <span class="keyword">if</span> nargin &gt; 10 ; scalx = varargin{4} ; scaly = varargin{5} ;
0149 <span class="keyword">else</span> ; scalx = 2 ; scaly = 2 ; <span class="keyword">end</span>
0150 <span class="keyword">if</span> nargin &gt; 12 ; iproxi = varargin{6} ; iproyi = varargin{7} ;
0151 <span class="keyword">else</span> ; iproxi = 0 ; iproyi = 0 ; <span class="keyword">end</span>
0152 <span class="keyword">if</span> nargin &gt; 14 ; xs = varargin{8} ;   ys = varargin{9} ; 
0153 <span class="keyword">else</span> ; xs = 0 ; ys = 0 ;<span class="keyword">end</span>
0154 <span class="keyword">if</span> nargin &gt; 15 ; br = varargin{10} ; <span class="keyword">else</span> ; br = 1 ; <span class="keyword">end</span>
0155 <span class="keyword">if</span> nargin &gt; 16 ; brs = varargin{11} ; <span class="keyword">else</span> ; brs = 1 ; <span class="keyword">end</span>
0156 <span class="keyword">if</span> nargin &gt; 18 ; naxmax = varargin{12} ;  naymax = varargin{13} ; 
0157 <span class="keyword">else</span> ; naxmax = 0 ;naymax = 0 ; <span class="keyword">end</span>
0158 <span class="keyword">if</span> nargin &gt; 19 ; iptyp = varargin{14} ; <span class="keyword">else</span> ; iptyp = 0 ; <span class="keyword">end</span>
0159 <span class="keyword">if</span> nargin &gt; 21 ; idampx = varargin{15} ;  idampy = varargin{16} ; 
0160 <span class="keyword">else</span> ; idampx = 0 ; idampy = 0 ; <span class="keyword">end</span>
0161 <span class="comment">%</span>
0162 <span class="comment">%  check of matrix dimension</span>
0163 <span class="comment">%</span>
0164 <span class="keyword">if</span> size(abcdx) == [ 2 2 ] ; abcdx = abcdx' ; abcdx = abcdx(:) ; <span class="keyword">end</span>
0165 <span class="keyword">if</span> size(abcdy) == [ 2 2 ] ; abcdy = abcdy' ; abcdy = abcdy(:) ; <span class="keyword">end</span>
0166 <span class="comment">%</span>
0167 <span class="comment">%  defaults</span>
0168 <span class="comment">%</span>
0169 efd(find(isnan(efd)==1))=0 ;
0170 npx  = numel( xp ); npy  = numel( yp );
0171 ddx = abs( xp(2) - xp(1) );  ddy = abs( yp(2) - yp(1) );
0172 xpmax = abs(xp(npx)); ypmax = abs(yp(npy));
0173 efds = zeros(npy,npx,1);
0174 ierr = 0 ; sterr = <span class="string">' '</span> ;
0175 iprox = 0 ; iproy = 0 ;
0176 sx = zeros(npx,1); sy = zeros(npy,1);
0177 Nfc = 1.0 ;                                     <span class="comment">% critical Fresnel number</span>
0178 lawc = 0.005 ;                                  <span class="comment">% critical value collimation</span>
0179 <span class="comment">%</span>
0180 <span class="comment">%  input error conditions</span>
0181 <span class="comment">%</span>
0182 <span class="keyword">if</span> sum(abs(xs)) == 0 || numel(xs) == 1 ; ixsfix = 0 ; <span class="keyword">else</span> ixsfix = 1 ; <span class="keyword">end</span>
0183 <span class="keyword">if</span> sum(abs(ys)) == 0 || numel(ys) == 1 ; iysfix = 0 ; <span class="keyword">else</span> iysfix = 1 ; <span class="keyword">end</span>
0184 <span class="keyword">if</span> ixsfix == 0 ; xs = zeros(npx,1); <span class="keyword">end</span>
0185 <span class="keyword">if</span> iysfix == 0 ; ys = zeros(npy,1); <span class="keyword">end</span>
0186 detx = abs( br - brs*( abcdx(1)*abcdx(4)-abcdx(2)*abcdx(3)) );
0187 <span class="keyword">if</span> detx &gt; 1.e-6 ; ierr = 1 ; sterr =<span class="string">'No consistence between indices abcdx matrix'</span>; <span class="keyword">end</span>
0188 dety = abs( br - brs*( abcdy(1)*abcdy(4)-abcdy(2)*abcdy(3)) );
0189 <span class="keyword">if</span> dety &gt; 1.e-6 ; ierr = 1 ; sterr =<span class="string">'No consistence between indices abcdy matrix'</span>; <span class="keyword">end</span>
0190 <span class="comment">%</span>
0191 <span class="keyword">if</span> ixsfix == 1 &amp;&amp; abs(npx-numel(xs))&gt;0 ; ierr = 2 ; 
0192 sterr =<span class="string">'incorrect length of the fixed grid vector xs'</span>; <span class="keyword">end</span>
0193 <span class="keyword">if</span> iysfix == 1 &amp;&amp; abs(npy-numel(ys))&gt;0 ; ierr = 2 ; 
0194 sterr =<span class="string">'incorrect length of the fixed grid vector ys'</span>; <span class="keyword">end</span>
0195 <span class="keyword">if</span> scalx &lt; 1 ; ierr = 4 ; sterr =<span class="string">'wrong value of scalex factor, must be s =&gt; 1'</span>; <span class="keyword">end</span>
0196 <span class="keyword">if</span> scaly &lt; 1 ; ierr = 4 ; sterr =<span class="string">'wrong value of scaley factor, must be s =&gt; 1'</span>; <span class="keyword">end</span>
0197 <span class="comment">%</span>
0198 <span class="comment">%  optional optimization of the best initial radii of curvature to flatten the field</span>
0199 <span class="comment">%</span>
0200 <span class="keyword">if</span> iropt &gt; 0
0201 [rx,ry] = <a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/curv_radius.html" class="code" title="function [rxo,ryo] = curv_radius(efd,wl,xp,yp,varargin)">curv_radius</a>(efd,wl,xp,yp,rx,ry);
0202 <span class="keyword">end</span>
0203 <span class="comment">%</span>
0204 <span class="comment">%  spatial frequencies sx, sy in 1/mm</span>
0205 <span class="comment">%</span>
0206 dsx = 1 / ( npx * ddx * scalx );  sxmax = (npx/2-1)*dsx ;
0207 <span class="keyword">for</span> j=1:npx ;    sx(j) = -sxmax-dsx +(j-1)*dsx ; <span class="keyword">end</span> ; 
0208 <span class="comment">%</span>
0209 dsy = 1 / ( npy * ddy * scaly );  symax = (npy/2-1)*dsy ;
0210 <span class="keyword">for</span> j=1:npy ;    sy(j) = -symax-dsy +(j-1)*dsy ; <span class="keyword">end</span> ; 
0211 <span class="comment">%__________________________________________________________________________</span>
0212 <span class="comment">%</span>
0213 <span class="comment">%  second moment in x and y direction and beam widths</span>
0214 <span class="comment">%</span>
0215 [xpm,ypm] = meshgrid( xp , yp );
0216 pow = sum(sum(abs(efd).^2)) ;
0217 wxmom = 2*sqrt( sum(sum( (xpm.^2).*abs(efd).^2 ))/pow );
0218 wymom = 2*sqrt( sum(sum( (ypm.^2).*abs(efd).^2 ))/pow );
0219 <span class="keyword">if</span> rx == 0 ; roxmom = 0 ; <span class="keyword">else</span> ; roxmom = 1/rx ; <span class="keyword">end</span>
0220 <span class="keyword">if</span> ry == 0 ; roymom = 0 ; <span class="keyword">else</span> ; roymom = 1/ry ; <span class="keyword">end</span>
0221 <span class="comment">%</span>
0222 <span class="comment">%  Propagation of w and R according to gaussian formulas</span>
0223 <span class="comment">%</span>
0224 zoxi = wl /(pi*wxmom^2);
0225 zoyi = wl /(pi*wymom^2);
0226 wxsmom = wxmom * sqrt( (abcdx(2)*zoxi)^2 + ( abcdx(1) - abcdx(2)*roxmom )^2 );
0227 wysmom = wymom * sqrt( (abcdy(2)*zoyi)^2 + ( abcdy(1) - abcdy(2)*roymom )^2 );
0228 rxsmom =-( (zoxi*abcdx(2))^2 + ( abcdx(1) - abcdx(2)*roxmom )^2 )<span class="keyword">...</span>
0229 /( ( abcdx(1) - abcdx(2)*roxmom )*( abcdx(3) - abcdx(4)*roxmom ) + abcdx(4)*abcdx(2)*zoxi^2 );
0230 rysmom =-( (zoyi*abcdy(2))^2 + ( abcdy(1) - abcdy(2)*roymom )^2 )<span class="keyword">...</span>
0231 /( ( abcdy(1) - abcdy(2)*roymom )*( abcdy(3) - abcdy(4)*roymom ) + abcdy(4)*abcdy(2)*zoyi^2 );
0232 <span class="keyword">if</span> rxsmom == 0 ; roxsmom = 0 ; <span class="keyword">else</span> ; roxsmom = 1/rxsmom ; <span class="keyword">end</span>
0233 <span class="keyword">if</span> rysmom == 0 ; roysmom = 0 ; <span class="keyword">else</span> ; roysmom = 1/rysmom ; <span class="keyword">end</span>
0234 <span class="comment">%</span>
0235 <span class="comment">%  Fresnel numbers for case decision</span>
0236 <span class="comment">%</span>
0237 Nfx  = wxmom*wxmom*abs(roxmom) / wl ;
0238 Nfsx = wxsmom*wxsmom*abs(roxsmom) / wl ;
0239 Nfy  = wymom*wymom*abs(roymom) / wl ;
0240 Nfsy = wysmom*wysmom*abs(roysmom) / wl ;
0241 <span class="comment">%</span>
0242 lawx = wl/wxmom/br ;   lawy = wl/wymom ;
0243 lawxs = wl/wxsmom  ;   lawys = wl/wysmom  ;
0244 <span class="comment">%__________________________________________________________________________</span>
0245 <span class="comment">%</span>
0246 <span class="comment">%  case selction in x</span>
0247 <span class="comment">%</span>
0248 <span class="keyword">if</span> rx == 0 ; rox = 0 ; <span class="keyword">else</span> ; rox = 1/rx ; <span class="keyword">end</span>
0249 <span class="comment">%</span>
0250 <span class="keyword">if</span> iproxi &gt; 0 ;    
0251 iprox = iproxi ;
0252 <span class="keyword">else</span> 
0253 <span class="keyword">if</span> Nfx &gt; Nfc &amp;&amp; Nfsx &gt; Nfc ;   iprox = 4 ;   <span class="keyword">end</span>   <span class="comment">%  O - O</span>
0254 <span class="keyword">if</span> Nfx &lt; Nfc &amp;&amp; Nfsx &gt; Nfc ;   iprox = 3 ;   <span class="keyword">end</span>   <span class="comment">%  I - O</span>
0255 <span class="keyword">if</span> Nfx &gt; Nfc &amp;&amp; Nfsx &lt; Nfc  ;  iprox = 2 ;   <span class="keyword">end</span>   <span class="comment">%  O - I</span>
0256 <span class="keyword">if</span> Nfx &lt; Nfc &amp;&amp; Nfsx &lt; Nfc ;   iprox = 1 ;   <span class="keyword">end</span>   <span class="comment">%  I - I</span>
0257 <span class="comment">%</span>
0258 <span class="comment">%  special cases with one side collimated</span>
0259 <span class="comment">%</span>
0260 <span class="keyword">if</span> iprox == 2 &amp;&amp; lawxs &lt; lawc ; iprox = 4 ; <span class="keyword">end</span>
0261 <span class="keyword">if</span> iprox == 3 &amp;&amp; lawx  &lt; lawc ; iprox = 4 ; <span class="keyword">end</span>
0262 <span class="keyword">if</span> iprox == 1 &amp;&amp; lawxs &lt; lawc &amp;&amp; lawx  &gt; lawc ; iprox = 3 ; <span class="keyword">end</span>
0263 <span class="keyword">if</span> iprox == 1 &amp;&amp; lawx  &lt; lawc &amp;&amp; lawxs &gt; lawc ; iprox = 2 ; <span class="keyword">end</span>
0264 <span class="keyword">end</span>
0265 <span class="comment">%</span>
0266 <span class="comment">%  magnification in x</span>
0267 <span class="comment">%</span>
0268 Mgeo = abcdx(1) - abcdx(2) * rox  ;
0269 xdif = wl * abs(abcdx(2)) * sxmax ;
0270 Mdif = xdif / xpmax ;
0271 <span class="comment">%</span>
0272 <span class="keyword">if</span> iprox == 1 ;    Mx = abcdx(1);  <span class="keyword">end</span>                   <span class="comment">%  case 1 : I - I</span>
0273 <span class="keyword">if</span> iprox == 2 ;    <span class="keyword">if</span> abs(Mgeo)&gt; Mdif ; Mx = Mgeo ;      <span class="comment">%  case 2 : O - I</span>
0274 <span class="keyword">else</span> ;             Mx = Mdif ;     <span class="keyword">end</span>  ;<span class="keyword">end</span>
0275 <span class="keyword">if</span> iprox == 3 ;    <span class="keyword">if</span> abs(Mgeo)&gt; Mdif ; Mx = Mgeo ;      <span class="comment">%  case 3 : I - O</span>
0276 <span class="keyword">else</span> ;             Mx = Mdif ;<span class="keyword">end</span>; <span class="keyword">end</span>     
0277 <span class="keyword">if</span> iprox == 4 ;    Mx = Mgeo  ;                 <span class="keyword">end</span>      <span class="comment">%  case 4 : O - O</span>
0278 <span class="comment">%</span>
0279 <span class="comment">%  fixed Mx in the case of given xs</span>
0280 <span class="comment">%  corrected flattening radius rox for I-O and O-O</span>
0281 <span class="comment">%  corrected scaling scalx for I-I and O-I</span>
0282 <span class="comment">%</span>
0283 <span class="keyword">if</span> ixsfix &gt; 0 
0284 Mx = max(xs)/xpmax;
0285 <span class="keyword">if</span> iprox == 4 || iprox == 3 ; rox = -(Mx-abcdx(1))/abcdx(2) ; <span class="keyword">end</span>
0286 <span class="keyword">if</span> iprox == 1 || iprox == 2
0287 xsmax = abs(xs(npx)) ; 
0288 scalx = wl*abs(abcdx(2))*npx/(4*xsmax*xpmax);
0289 <span class="keyword">if</span> scalx &lt; 1 ; ierr = 3 ; sterr = <span class="string">'fixed xs causes sampling error'</span>; <span class="keyword">end</span>
0290 dsx = 1 / ( npx * ddx * scalx );  sxmax = (npx/2-1)*dsx ;
0291 <span class="keyword">for</span> j=1:npx ;    sx(j) = -sxmax-dsx +(j-1)*dsx ; <span class="keyword">end</span> ; 
0292 <span class="keyword">end</span>
0293 <span class="keyword">else</span>
0294 xs  = xp * abs(Mx) ; 
0295 <span class="keyword">end</span>
0296 <span class="comment">%</span>
0297 <span class="comment">%  geometrical curvature in the final plane : rxsg</span>
0298 <span class="comment">%  1. no contribution for the case I-I</span>
0299 <span class="comment">%  2. special cases of only one Fourier transforms I-O and O-I</span>
0300 <span class="comment">%  3. purely geometrical case O-O with complete equivalence transform</span>
0301 <span class="comment">%</span>
0302 <span class="keyword">if</span> iprox == 1
0303     rxsg = 0 ; roxsg = 0 ;
0304 <span class="keyword">elseif</span>  iprox == 3 || iprox == 2
0305     <span class="keyword">if</span> abs(abcdx(4)) &gt;0 ; 
0306         rxsg = -abcdx(2)/abcdx(4) ;
0307         <span class="keyword">if</span> abs(rxsg)&gt;0 ; roxsg = 1/rxsg ; <span class="keyword">else</span> ; roxsg = 0 ; <span class="keyword">end</span>
0308     <span class="keyword">else</span>
0309          rxsg = 0 ; roxsg = 0 ;
0310     <span class="keyword">end</span>
0311 <span class="keyword">else</span>
0312     <span class="keyword">if</span> abs( Mx*abcdx(4)-1 ) &gt; 0 ; 
0313         rxsg = -( Mx*abcdx(2) ) / ( Mx*abcdx(4)-1 );   
0314         <span class="keyword">if</span> abs(rxsg)&gt;0 ; roxsg = 1/rxsg ; <span class="keyword">else</span> ; roxsg = 0 ; <span class="keyword">end</span>
0315     <span class="keyword">else</span>
0316         rxsg = 0 ; roxsg = 0 ;
0317     <span class="keyword">end</span>
0318 <span class="keyword">end</span>
0319 <span class="comment">%</span>
0320 <span class="comment">%  effective propagation distance Beffx</span>
0321 <span class="comment">%</span>
0322 Beffx = abcdx(2) / Mx  ;
0323 <span class="comment">%</span>
0324 <span class="comment">%  Correction of the initial geometrical flattening curvature roxg as exact</span>
0325 <span class="comment">%  Fourier conjugated plane for the cases O-I and I-O with only one FFT.</span>
0326 <span class="comment">%  No geometrical contribution in the case I-I</span>
0327 <span class="comment">%</span>
0328 <span class="keyword">if</span> iprox == 2 || iprox == 3
0329 roxg = abcdx(1) / abcdx(2) ;
0330 <span class="keyword">elseif</span> iprox == 1
0331 roxg = 0 ; 
0332 <span class="keyword">else</span>
0333 roxg = rox ; 
0334 <span class="keyword">end</span>
0335 <span class="comment">%__________________________________________________________________________</span>
0336 <span class="comment">%</span>
0337 <span class="comment">%  case selection in y</span>
0338 <span class="comment">%</span>
0339 <span class="keyword">if</span> ry == 0 ; roy = 0 ; <span class="keyword">else</span> ; roy = 1/ry ; <span class="keyword">end</span>
0340 <span class="comment">%</span>
0341 <span class="keyword">if</span> iproyi &gt; 0 ;    
0342 iproy = iproyi ;
0343 <span class="keyword">else</span> 
0344 <span class="keyword">if</span> Nfy &gt; Nfc &amp;&amp; Nfsy &gt; Nfc ;   iproy = 4 ;   <span class="keyword">end</span>   <span class="comment">%  O - O</span>
0345 <span class="keyword">if</span> Nfy &lt; Nfc &amp;&amp; Nfsy &gt; Nfc ;   iproy = 3 ;   <span class="keyword">end</span>   <span class="comment">%  I - O</span>
0346 <span class="keyword">if</span> Nfy &gt; Nfc &amp;&amp; Nfsy &lt; Nfc  ;  iproy = 2 ;   <span class="keyword">end</span>   <span class="comment">%  O - I</span>
0347 <span class="keyword">if</span> Nfy &lt; Nfc &amp;&amp; Nfsy &lt; Nfc ;   iproy = 1 ;   <span class="keyword">end</span>   <span class="comment">%  I - I</span>
0348 <span class="comment">%</span>
0349 <span class="comment">%  special cases with one side collimated</span>
0350 <span class="comment">%</span>
0351 <span class="keyword">if</span> iproy == 2 &amp;&amp; lawys &lt; lawc ; iproy = 4 ; <span class="keyword">end</span>
0352 <span class="keyword">if</span> iproy == 3 &amp;&amp; lawy  &lt; lawc ; iproy = 4 ; <span class="keyword">end</span>
0353 <span class="keyword">if</span> iproy == 1 &amp;&amp; lawys &lt; lawc &amp;&amp; lawy  &gt; lawc ; iproy = 3 ; <span class="keyword">end</span>
0354 <span class="keyword">if</span> iproy == 1 &amp;&amp; lawy  &lt; lawc &amp;&amp; lawys &gt; lawc ; iproy = 2 ; <span class="keyword">end</span>
0355 <span class="keyword">end</span>
0356 <span class="comment">%</span>
0357 <span class="comment">%  magnification in y</span>
0358 <span class="comment">%</span>
0359 Mgeo = abcdy(1) - abcdy(2) * roy  ;
0360 ydif = wl * abs(abcdy(2)) * symax ;
0361 Mdif = ydif / ypmax ;
0362 <span class="comment">%</span>
0363 <span class="keyword">if</span> iproy == 1 ;    My = abcdy(1);  <span class="keyword">end</span>                       <span class="comment">%  case 1 : I - I</span>
0364 <span class="keyword">if</span> iproy == 2 ;    <span class="keyword">if</span> abs(Mgeo)&gt; Mdif ; My = Mgeo     ;      <span class="comment">%  case 2 : O - I</span>
0365 <span class="keyword">else</span> ;             My = Mdif ;     <span class="keyword">end</span>     
0366 <span class="keyword">end</span>
0367 <span class="keyword">if</span> iproy == 3 ;    <span class="keyword">if</span> abs(Mgeo)&gt; Mdif ; My = Mgeo     ;      <span class="comment">%  case 3 : I - O</span>
0368 <span class="keyword">else</span> ;             My = Mdif ;<span class="keyword">end</span>; <span class="keyword">end</span>     
0369 <span class="keyword">if</span> iproy == 4 ;    My = Mgeo  ;                         <span class="keyword">end</span>  <span class="comment">%  case 4 : O - O</span>
0370 <span class="comment">%</span>
0371 <span class="comment">%  fixed My in the case of given ys</span>
0372 <span class="comment">%  corrected flattening radius roy for O-O</span>
0373 <span class="comment">%  corrected scaling scalx for I-I and O-I</span>
0374 <span class="comment">%</span>
0375 <span class="keyword">if</span> iysfix &gt; 0 
0376 My = max(ys)/ypmax;
0377 <span class="keyword">if</span> iproy == 4 || iproy == 3 ; roy = -(My-abcdy(1))/abcdy(2) ; <span class="keyword">end</span>
0378 <span class="keyword">if</span> iproy == 1 || iproy == 2
0379 ysmax = abs(ys(npy)) ; 
0380 scaly = wl*abs(abcdy(2))*npy/(4*ysmax*ypmax);
0381 <span class="keyword">if</span> scaly &lt; 1 ; ierr = 3 ; sterr = <span class="string">'fixed ys causes sampling error'</span>; <span class="keyword">end</span>
0382 dsy = 1 / ( npy * ddy * scaly );  symax = (npy/2-1)*dsy ;
0383 <span class="keyword">for</span> j=1:npy ;    sy(j) = -symax-dsy +(j-1)*dsy ; <span class="keyword">end</span> ; 
0384 <span class="keyword">end</span>
0385 <span class="keyword">else</span>
0386 ys  = yp * abs(My) ; 
0387 <span class="keyword">end</span>
0388 <span class="comment">%</span>
0389 <span class="comment">%  curvature in the final plane : rysg</span>
0390 <span class="comment">%  1. no contribution for the case I-I</span>
0391 <span class="comment">%  2. special case of only one Fourier transforms I-O and O-I</span>
0392 <span class="comment">%  3. purely geometrical case O-O with complete equivalence transform</span>
0393 <span class="comment">%</span>
0394 <span class="keyword">if</span> iproy ==1
0395     rysg = 0 ; roysg = 0 ;
0396 <span class="keyword">elseif</span> iproy == 3 || iproy == 2
0397     <span class="keyword">if</span> abs(abcdy(4)) &gt; 0 ; 
0398         rysg = -abcdy(2)/abcdy(4) ;
0399         <span class="keyword">if</span> abs(rysg)&gt;0 ; roysg = 1/rysg ; <span class="keyword">else</span> ; roysg = 0 ; <span class="keyword">end</span>
0400     <span class="keyword">else</span>
0401         rysg = 0 ; roysg = 0 ;
0402     <span class="keyword">end</span>
0403 <span class="keyword">else</span>
0404     <span class="keyword">if</span> abs( My*abcdy(4)-1 ) &gt; 0 ; 
0405         rysg = -( My*abcdy(2) ) / ( My*abcdy(4)-1 );   
0406         <span class="keyword">if</span> abs(rysg)&gt;0 ; roysg = 1/rysg ; <span class="keyword">else</span> ; roysg = 0 ; <span class="keyword">end</span>
0407     <span class="keyword">else</span>
0408         rysg = 0 ; roysg = 0 ;
0409     <span class="keyword">end</span>
0410 <span class="keyword">end</span>
0411 <span class="comment">%</span>
0412 <span class="comment">%  effective propagation distance Beffy</span>
0413 <span class="comment">%</span>
0414 Beffy = abcdy(2) / My  ;
0415 <span class="comment">%</span>
0416 <span class="comment">%  Correction of the initial geometrical flattening curvature roxg as exact</span>
0417 <span class="comment">%  Fourier conjugated plane for the cases O-I and I-O with only one FFT.</span>
0418 <span class="comment">%  No geometrical contribution in the case I-I</span>
0419 <span class="comment">%</span>
0420 <span class="keyword">if</span> iproy == 2 || iproy == 3
0421 royg = abcdy(1) / abcdy(2) ;
0422 <span class="keyword">elseif</span> iproy == 1
0423 royg = 0 ; 
0424 <span class="keyword">else</span>
0425 royg = roy ; 
0426 <span class="keyword">end</span>
0427 <span class="comment">%__________________________________________________________________________</span>
0428 <span class="comment">%</span>
0429 <span class="comment">%  Computation :</span>
0430 <span class="comment">%</span>
0431 <span class="comment">%  matrices of final spatial coordinates and frequencies</span>
0432 <span class="comment">%</span>
0433 [sxm,sym] = meshgrid( sx , sy );
0434 [xsm,ysm] = meshgrid( xs , ys );
0435 <span class="comment">%</span>
0436 <span class="comment">%  flattening of the input field if start outside the focal region</span>
0437 <span class="comment">%</span>
0438 <span class="keyword">if</span> abs(roxg) &gt; 0 ;  efd  = efd .* exp( -1i * pi / wl * roxg * xpm.^2 );  <span class="keyword">end</span>
0439 <span class="keyword">if</span> abs(royg) &gt; 0 ;  efd  = efd .* exp( -1i * pi / wl * royg * ypm.^2 );  <span class="keyword">end</span>
0440 <span class="comment">%</span>
0441 <span class="comment">%  Fourier or chirp-z-transform</span>
0442 <span class="comment">%</span>
0443 <span class="keyword">if</span> scalx == 1 &amp;&amp; scaly == 1 
0444 famp = fftshift(fft2(efd));
0445 <span class="keyword">else</span>
0446 famp =  conj( <a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/czt_2d.html" class="code" title="function xout = czt_2d( xin , scalx , scaly , idir )">czt_2d</a>( efd , scaly , scalx , 0 ) );
0447 <span class="keyword">end</span>
0448 <span class="comment">%</span>
0449 <span class="comment">%  optional damping the frequency spectrum</span>
0450 <span class="comment">%</span>
0451 <span class="keyword">if</span> idampx &gt; 0
0452 <span class="keyword">if</span> idampx &gt; 1 ; idampx = 0.5 ; <span class="keyword">end</span>
0453 dampx = zeros(npx,1); n2x = npx/2+1 ; ex = idampx ;
0454 <span class="keyword">for</span> j=1:npx ;  dampx(j) = 0.5 *( 1 + cos( (j-n2x)/n2x *pi ) );  <span class="keyword">end</span>
0455 dampx = abs( dampx ).^ex;
0456 <span class="keyword">else</span>
0457 dampx = ones(npx,1);
0458 <span class="keyword">end</span>
0459 <span class="keyword">if</span> idampy &gt; 0
0460 dampy = zeros(npy,1); n2y = npy/2+1 ; ey = idampy ;
0461 <span class="keyword">for</span> j=1:npy ;  dampy(j) = 0.5 *( 1 + cos( (j-n2y)/n2y *pi ) );  <span class="keyword">end</span>
0462 dampy = abs( dampy ).^ey;
0463 <span class="keyword">else</span>
0464 dampy = ones(npy,1);
0465 <span class="keyword">end</span>
0466 <span class="keyword">if</span> idampx &gt; 0 || idampy &gt; 0
0467 [dampmx , dampmy ] = meshgrid( dampx , dampy );
0468 famp = famp .* dampmx .* dampmy ; 
0469 clear dampmx ; clear dampmy ;
0470 <span class="keyword">end</span>
0471 <span class="comment">%</span>
0472 <span class="comment">%  optional truncation for finite aperture angle in selected cases</span>
0473 <span class="comment">%  calculation of the decrease in beam power</span>
0474 <span class="comment">%</span>
0475 <span class="keyword">if</span> (   ( ( iprox == 4 || iprox == 3 || iprox == 1) &amp;&amp; naxmax &gt; 0 )<span class="keyword">...</span>
0476 || ( ( iproy == 4 || iproy == 3 || iproy == 1) &amp;&amp; naymax &gt; 0 ) );
0477 <span class="keyword">if</span> naxmax &gt; 0 ; sxtrunc = 2*naxmax/wl/br ; <span class="keyword">else</span> ; sxtrunc = sxmax*1.1 ; <span class="keyword">end</span> 
0478 <span class="keyword">if</span> naymax &gt; 0 ; sytrunc = 2*naymax/wl/br ; <span class="keyword">else</span> ; sytrunc = symax*1.1 ; <span class="keyword">end</span> 
0479 ind = find( abs(sxm)&gt;sxtrunc | abs(sym)&gt;sytrunc ); 
0480 <span class="keyword">if</span> numel(ind)&gt;0 ; 
0481 famp(ind) = 0 ; 
0482 <span class="keyword">end</span>
0483 <span class="keyword">end</span>
0484 <span class="comment">%</span>
0485 <span class="comment">%  transport in frequency space, 2 different impulse response functions</span>
0486 <span class="comment">%  iptyp = 0 : Fresnel approximation</span>
0487 <span class="comment">%  iptyp = 1 : Plane wave propagation</span>
0488 <span class="comment">%</span>
0489 <span class="keyword">if</span> iptyp == 0                                              <span class="comment">%  Fresnel</span>
0490 fakx = 1i*pi*wl*Beffx ;   faky = 1i*pi*wl*Beffy ;
0491 famp = famp .* exp( fakx * sxm.^2 + faky * sym.^2  );
0492 <span class="comment">%</span>
0493 <span class="keyword">elseif</span> iptyp == 1                                          <span class="comment">%  plane waves</span>
0494 ilaq = (1/wl)^2 ;
0495 famp = famp .* exp( 2*pi*1i* Beffx * sqrt( abs ( ilaq - sxm.^2 - sym.^2  )) );
0496 <span class="comment">%</span>
0497 <span class="keyword">end</span>
0498 <span class="comment">%</span>
0499 <span class="comment">%  inverse Fourier transform for O - O and I - I and return to space domain</span>
0500 <span class="comment">%  reverse direction of the spatial x-coordinate, if Mx &lt; 0</span>
0501 <span class="comment">%  reverse direction of the spatial y-coordinate, if My &lt; 0</span>
0502 <span class="comment">%  1. both sections</span>
0503 <span class="comment">%  2. only x-section</span>
0504 <span class="comment">%  3. only y-section</span>
0505 <span class="comment">%</span>
0506 <span class="keyword">if</span> ( iprox == 1 || iprox == 4 ) &amp;&amp; ( iproy == 1 || iproy == 4 ) 
0507 <span class="keyword">if</span> scalx == 1 &amp;&amp; scaly == 1
0508 efds = ifft2(ifftshift(famp));  <span class="comment">% version Schuster</span>
0509 <span class="keyword">else</span>
0510 efds =  <a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/czt_2d.html" class="code" title="function xout = czt_2d( xin , scalx , scaly , idir )">czt_2d</a>( famp , scaly , scalx , 0 )  / ( npx*npy*scalx*scaly ); 
0511 <span class="keyword">end</span>
0512 <span class="comment">%</span>
0513 <span class="keyword">elseif</span> ( iprox == 1 || iprox == 4 ) &amp;&amp; ( iproy == 2 || iproy == 3 ) 
0514 efds =  <a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/czt_2d.html" class="code" title="function xout = czt_2d( xin , scalx , scaly , idir )">czt_2d</a>( famp , scaly , scalx , 2 )  / (npx*scalx*sqrt(scaly*npy)); 
0515 <span class="comment">%</span>
0516 <span class="keyword">elseif</span> ( iprox == 2 || iprox == 3 ) &amp;&amp; ( iproy == 1 || iproy == 4 ) 
0517 efds =  <a href="../../../../AODParentDir/Diffraction_Module/Existing_Propagators/czt_2d.html" class="code" title="function xout = czt_2d( xin , scalx , scaly , idir )">czt_2d</a>( famp , scaly , scalx , 1 )  / (npy*scaly*sqrt(npx*scalx)); 
0518 <span class="comment">%</span>
0519 <span class="keyword">elseif</span> ( iprox == 2 || iprox == 3 ) &amp;&amp; ( iproy == 2 || iproy == 3 ) 
0520 efds = famp / (sqrt(npy*scaly*npx*scalx)); 
0521 <span class="keyword">end</span>
0522 <span class="keyword">if</span> Mx &lt; 0 ;     efds(:,2:npx) = efds(:,npx:-1:2) ;<span class="keyword">end</span>
0523 <span class="keyword">if</span> My &lt; 0 ;     efds(2:npy,:) = efds(npy:-1:2,:) ;<span class="keyword">end</span>
0524 <span class="keyword">if</span> iprox == 3 || iprox == 2 ;  efds(:,2:npx) = efds(:,npx:-1:2) ;<span class="keyword">end</span>
0525 <span class="keyword">if</span> iproy == 3 || iproy == 2  ; efds(2:npy,:) = efds(npy:-1:2,:) ;<span class="keyword">end</span>
0526 <span class="comment">%__________________________________________________________________________</span>
0527 <span class="comment">%</span>
0528 <span class="comment">%  Scaling of the spectrum famp</span>
0529 <span class="comment">%  correction of the field for the final geometrical curvature</span>
0530 <span class="comment">%</span>
0531 famp = abs( famp ); famp = famp / max(max(famp));
0532 <span class="keyword">if</span> abs(roxsg) &gt; 0 ;  efds = efds .* exp(  1i*pi*roxsg/wl * xsm.^2   ); <span class="keyword">end</span>
0533 <span class="keyword">if</span> abs(roysg) &gt; 0 ;  efds = efds .* exp(  1i*pi*roysg/wl * ysm.^2   ); <span class="keyword">end</span>
0534 <span class="comment">%</span>
0535 <span class="comment">%  correction for sign-oscillation, if only one FFT is performed</span>
0536 <span class="comment">%  and the original FFT is used</span>
0537 <span class="comment">%</span>
0538 <span class="keyword">if</span> ( iprox == 2 || iprox == 3 ) &amp;&amp; scalx == 1 &amp;&amp; scaly == 1
0539    revers = (-1).^[1:npx] ;
0540    <span class="keyword">for</span> k=1:npy ;   efds(k,:) = efds(k,:) .* revers; <span class="keyword">end</span>
0541 <span class="keyword">end</span>
0542 <span class="keyword">if</span> ( iproy == 2 || iproy == 3 ) &amp;&amp; scalx == 1 &amp;&amp; scaly == 1
0543    revers = (-1).^[1:npy]' ;
0544    <span class="keyword">for</span> j=1:npx ;   efds(:,j) = efds(:,j) .* revers; <span class="keyword">end</span>
0545 <span class="keyword">end</span>
0546 <span class="comment">%</span>
0547 
0548 
0549 
0550 
0551 
0552 
0553 
0554 
0555 
0556 
0557 
0558 
0559 
0560 
0561 
0562</pre></div>
<hr><address>Generated on Thu 22-May-2014 16:03:22 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>